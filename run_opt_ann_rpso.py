# Run the RPSO to optimize the weights and biases of an ANN
from __future__ import division
import sys
import time
import numpy as np
import multiprocessing
from functools import partial
import pandas as pd
import tensorflow as tf
from CostFunctions import get_fingerprinted_data, get_fingerprinted_data_noisy

from RPSO import RPSO
from Statistics import save_opt_ann_rpso_stats
from pso_options import create_model


X_train, _, y_train, _, _ = get_fingerprinted_data()
model, num_dimensions = create_model()


def ann_weights_fitness_function(particle, model):
    for layer in model.layers:
        weights = layer.get_weights()[0]
        biases = layer.get_weights()[1]
        num_weights = weights.size
        num_biases = biases.size

        # Slice off values from the continuous_values array for weights and biases
        sliced_weights = particle[:num_weights]
        sliced_biases = particle[num_weights: num_weights + num_biases]

        # Update the continuous_values array for the next iteration
        particle = particle[num_weights + num_biases:]

        # Set the sliced weights and biases in the layer
        layer.set_weights(
            [sliced_weights.reshape(weights.shape),
             sliced_biases.reshape(biases.shape)]
        )
    try:
        model.compile(optimizer="adam", loss="mse")

        # Evaluate the model and get the evaluation metrics
        evaluation_metrics = model.evaluate(X_train, y_train, verbose=0)
        rmse = np.sqrt(evaluation_metrics)

        return rmse
    except tf.errors.InvalidArgumentError as e:
        # Handle the specific exception here
        print("Caught an InvalidArgumentError:", e)
        # You can choose to return a specific value or take other actions
        return float("inf")  # For example, return infinity in case of an error
    except tf.errors.OpError as e:
        # Handle TensorFlow-specific errors here
        print(f"TensorFlow error: {e}")
        return float("inf")  # For example, return infinity in case of an error
    except Exception as e:
        # Handle other exceptions here
        print(f"An error occurred: {e}")
        return float("inf")  # For example, return infinity in case of an error


def run_pso(
    _,
    iterations,
    position_bounds,
    velocity_bounds,
    fitness_threshold,
    num_particles,
    Cp_min,
    Cp_max,
    Cg_min,
    Cg_max,
    w_min,
    w_max,
    gwn_std_dev,
):
    swarm = RPSO(
        iterations,
        num_particles,
        num_dimensions,
        position_bounds,
        velocity_bounds,
        Cp_min,
        Cp_max,
        Cg_min,
        Cg_max,
        w_min,
        w_max,
        fitness_threshold,
        ann_weights_fitness_function,
        gwn_std_dev,
    )

    swarm.run_pso(model)

    return (
        swarm.swarm_best_fitness,
        swarm.swarm_best_position,
        swarm.swarm_fitness_history,
        swarm.swarm_position_history,
    )


if __name__ == "__main__":
    # ---- RSPO options ----
    position_bounds = [(-1.0, 1.0)] * num_dimensions
    velocity_bounds = [(-0.2, 0.2)] * num_dimensions
    fitness_threshold = 0.1
    num_particles = 60
    # Cp_min = 0.1
    # Cp_max = 3.5
    # Cg_min = 0.9
    # Cg_max = 3.0
    # w_min = 0.3
    # w_max = 1.7
    # gwn_std_dev = 0.15
    iterations = 100

    Cp_min = [0.2818661704147518, 0.24232080746345505, 0.11056635644714477, 0.4386946917243003, 0.4416757049700176, 0.42931400234610795, 0.4244486515555669, 0.2751116924620188, 0.4990954800535484, 0.36013427266986764, 0.486397396447417, 0.45556166313994273, 0.11444830517291123, 0.43449864965614904, 0.23340140174624113, 0.24447074828080653, 0.43253647712020593, 0.18000808514336955, 0.4631928477826025, 0.1834237555016679, 0.3613209236015723, 0.46369183201364084, 0.24942222836492114, 0.11203552997281961, 0.1878281949163129, 0.11152265126602066, 0.43494327730970317, 0.38472808605409026, 0.3836142850789386, 0.45781242238730846, 0.28113323438083304, 0.27540264809466997, 0.2710850576952405, 0.44152014273910145, 0.49569114741025333, 0.27550234891554615, 0.15440285629504147, 0.30583671478535746, 0.22282240681042254, 0.4551577409554328, 0.27734202481448145, 0.4872260795841281, 0.45551748797998515, 0.2503159217462271, 0.23957975379981705, 0.44762662262533515, 0.18711205878042692, 0.4551645719624885, 0.4954846772897983, 0.1812927135436666,
              0.16046295814511763, 0.43782611002501926, 0.3311559290903924, 0.3449846738425998, 0.14762109542461543, 0.14752620860983656, 0.23836773791051044, 0.466148455171847, 0.45720910581804375, 0.38420810290869, 0.28313778686620916, 0.20240355876238159, 0.45834970374416895, 0.22887292349128324, 0.2404211934814681, 0.4403130890936434, 0.36132208364888097, 0.2221284409690678, 0.2704951135961339, 0.493828004419376, 0.27302928936106047, 0.2585433944732958, 0.3885497647585199, 0.18130918883407254, 0.11991403462096609, 0.3968248825920555, 0.28045410004536164, 0.14865771657113824, 0.125858687249717, 0.29241178651541544, 0.12514599174683078, 0.4607639669349878, 0.35044728202058395, 0.37835253496510224, 0.12139058694943015, 0.333114018853061, 0.38881746756271773, 0.344857267216814, 0.31787443754570444, 0.17119537861166811, 0.18594913651009498, 0.13272276452153917, 0.332488628222665, 0.46802177746494844, 0.11608683816365609, 0.4026130862119216, 0.2760541557854286, 0.45553018130129297, 0.1567308385493953, 0.12878599498858076]
    Cp_max = [3.0237980599533105, 2.922794609070217, 3.0931866609367087, 3.2261294615074356, 2.5198537582813807, 2.55075160682692, 2.814418393675558, 2.8784039988023524, 2.77149235779353, 2.601845397253616, 3.4213070557598924, 2.6089036086607553, 3.41710192242423, 2.8340190563897387, 2.8589916165596403, 2.8081944432124413, 3.227177777583454, 3.1698056136176462, 2.8876158399075744, 2.8525970530818485, 2.951330874878175, 2.637761036812187, 2.7386740089582706, 2.84980891690194, 2.7678510208825498, 2.5877198881229675, 2.5345675882426013, 3.4063574261578515, 3.3827795755468495, 3.333743819054484, 2.5610446055861362, 3.0553235941836077, 3.2258974906800324, 2.886724737763897, 3.1480825601256353, 2.806704747745026, 2.9416553836251866, 3.21795580358013, 2.553111348681027, 2.744280845300609, 3.456846344667253, 2.951681200588248, 2.804537317858191, 2.6892183950670465, 3.2469486013073006, 3.4017897261275465, 2.8913978370991833, 3.430082373356247, 3.2634445963834047, 2.764840799003344,
              3.2642143140456383, 3.1902989265079746, 2.638533149030761, 3.335347487578483, 3.0148218442755534, 2.928910711956319, 2.6272032582147866, 3.028352221421142, 2.7120971501706466, 3.1702236213201673, 2.682207720818078, 3.1593510040296664, 3.238578465593526, 2.6497298673906915, 2.6819610909500144, 2.830113102794298, 2.649352159871036, 3.4776096220191466, 3.0177113625647345, 2.61014146752128, 2.8288732371493146, 2.571554829141526, 2.977127421460635, 2.8975395800598647, 2.5621293522635344, 3.3351863779072515, 2.5092620302051314, 3.137209300185705, 3.41268817702453, 3.4982243402969315, 3.045691730178825, 2.9139539348165964, 2.684241482811011, 2.9753117412983006, 2.5431585519770494, 3.4745064468232414, 3.436697081255425, 2.8365695366743995, 3.2897594879237824, 2.578446022412579, 2.5576281205262754, 2.6243708820312235, 2.7290287476474187, 2.8948759164400215, 2.5595515202809724, 3.128839235361424, 3.1965179949172713, 2.678443309985643, 3.103197321983843, 2.9201982274798315]
    Cg_min = [0.6147036701103308, 0.7749369017389849, 0.525923628556574, 0.8706185442421779, 0.5818376365267999, 0.8919603440811636, 0.7460162103069323, 0.7547851881472252, 0.5403516844376919, 0.752566773788645, 0.833696226325852, 0.6223585670714923, 0.6692872124205212, 0.6051998326147205, 0.8423403461860983, 0.8591325485987021, 0.5030615813256967, 0.6627079744529327, 0.7513816912000378, 0.6011956132716975, 0.8285612019409477, 0.5446112220718691, 0.5532564880024392, 0.7918378088375051, 0.5174454265964902, 0.7674720038522118, 0.7245924663032374, 0.8846323144958749, 0.8492554482831767, 0.6665617006924287, 0.5547923086394738, 0.5325844157659583, 0.6955484401621458, 0.7263397293075564, 0.8505121045994393, 0.5983202425930211, 0.6657511595572472, 0.7370069256872103, 0.6972630581980063, 0.7630356880120963, 0.752940197270011, 0.8277793975279537, 0.8840523542358143, 0.5217230709264586, 0.5376975740885437, 0.7301459835914834, 0.5457327172032361, 0.7630447298024352, 0.5984717546122424, 0.8393254610493082,
              0.7424522349151619, 0.8575843781749704, 0.7367841447014909, 0.8678045542022746, 0.5253092214074975, 0.8747120994295292, 0.6049207316956868, 0.5272831663770587, 0.8082268976071086, 0.8586351893050351, 0.7978354876509777, 0.8789031143829247, 0.8535110405464983, 0.6421477123583683, 0.5869744301528772, 0.8569639420702981, 0.6125929287201065, 0.827477965335877, 0.5779957362728695, 0.7095420398652504, 0.7000898924970611, 0.7130835845847114, 0.737155479198522, 0.8101838312633673, 0.8406652600220592, 0.6322409745313919, 0.7464402328636914, 0.5638498246190455, 0.8026644473731985, 0.7055534767731695, 0.8566040560130685, 0.7072097970962644, 0.5250595481030034, 0.7980640358918378, 0.7532147117198675, 0.8473235512670539, 0.5585447499608684, 0.6842115473997475, 0.6377781805658262, 0.7656272713163512, 0.5797778475140417, 0.6494166558557466, 0.5162435875509918, 0.5245598900248964, 0.5045471366653452, 0.6599833005054556, 0.6803491218119077, 0.6427952063367574, 0.8430322990979453, 0.8918166101353888]
    Cg_max = [2.551548251802985, 2.9319064585078918, 3.2936576238783695, 3.155499158477932, 3.4675610900461518, 3.4800033416569516, 2.8237351678865057, 3.484301314443351, 3.2909176927016497, 2.755641833880813, 3.0781625323559374, 3.492074426536769, 3.0959137185797916, 2.7629419676807467, 3.0175016332784788, 3.2215733671123186, 2.822100141347904, 3.4152907267937485, 3.3492683581113445, 3.338509186109652, 3.1799910479563103, 2.5713524091292674, 2.549657755983214, 3.430273937647684, 2.834804922733991, 3.488657578322468, 2.75931413342785, 3.189941441836372, 3.0392260241164726, 3.39186471455871, 3.4148507138144115, 3.2213383888551106, 3.176047980086853, 3.1687968672422056, 3.4005456597335106, 2.8693552966559253, 3.0033215702343004, 3.14249033378758, 3.016525754102902, 2.9683441609206875, 2.746470818684707, 3.054007542914559, 2.559241003745164, 3.3045646510667575, 3.118027057791283, 3.203562540375786, 2.5671144047359564, 3.303462794061389, 2.989195747743079, 3.062731463982591,
              3.083569899441264, 3.43672551103427, 3.3766811484577066, 3.0983054235388487, 3.4420069709331695, 3.293071695298395, 2.8644333047894497, 3.3416514181613826, 2.908648206480893, 3.2174123881399215, 2.8963524959265725, 3.3945010380324208, 3.486309015104367, 3.1042537290278283, 2.9307111685635188, 2.770754605348799, 3.327384430738254, 2.8523503539981974, 2.536229171503544, 3.066889517637308, 3.420238189145673, 3.116255536257122, 3.0867994871955386, 3.223872849619126, 2.7928264282249766, 3.2850985275684055, 2.994593986917324, 3.232761539690732, 2.6039595022272417, 2.8075031145328686, 3.190203542867552, 3.3669396081349827, 3.119055056725933, 3.4168137609713813, 3.2507571328901785, 2.694483655592094, 2.86322335332677, 2.644796921908304, 3.229083502241464, 2.8673260332191246, 3.422227344083011, 2.9651635029545003, 2.5943834822670437, 2.6662244532512474, 2.686828854517179, 2.975773845136936, 3.297000200543369, 3.266382233098596, 2.6324414938309912, 2.9029340138166013]
    w_min = [0.3718390162385376, 0.3168847900596456, 0.31184269355987243, 0.38868039202773563, 0.38696367743825677, 0.367848596980713, 0.31777707098160746, 0.36763212588351313, 0.3036050185029503, 0.3699308540464369, 0.335984387828371, 0.3254131485105257, 0.37314365025109175, 0.33294158916033295, 0.3844236299525557, 0.3808461279056724, 0.38415809849640803, 0.32274381151778875, 0.35001671793704175, 0.3937356821419164, 0.31836553096778064, 0.3230889730360854, 0.3696586117763402, 0.3439821798275769, 0.3750044353968582, 0.32887411440549225, 0.31744782217151163, 0.3193515369461601, 0.34650401294118666, 0.35802350694158835, 0.3490804977963161, 0.307127364793143, 0.37311169297183094, 0.3447312001042748, 0.36790184455649, 0.32547419918054044, 0.3140839846060116, 0.3786856398747859, 0.352852445990287, 0.3148384600900934, 0.30417913168963234, 0.3558855262414732, 0.3970866107650518, 0.39790821905100526, 0.31775824837986577, 0.3176051812984926, 0.3518640020621956, 0.3678909970591073, 0.3057438902218475, 0.3147870762648189,
             0.39366036213289, 0.37668432973472543, 0.373112313875986, 0.31820680360661857, 0.3199660753714771, 0.3166749614313752, 0.3111954603317039, 0.3069721911294009, 0.3654077760859671, 0.3927530047740319, 0.35710370133836755, 0.36952540922451144, 0.39063277736065105, 0.3199093779394549, 0.3119385594535352, 0.30538183590895396, 0.35517208716740956, 0.3298526243540601, 0.3018558002799237, 0.3444156964899503, 0.3602485044166387, 0.33936252496906866, 0.35362472977463916, 0.3420553224398044, 0.3467307598653043, 0.3141261833063083, 0.35085181381028674, 0.3221296679297563, 0.3502339177183231, 0.3814228548769733, 0.37974698440222776, 0.348290060411828, 0.34110092602545805, 0.3217052111302615, 0.3195283311896024, 0.34240243378145885, 0.30037228910952907, 0.33270079366202915, 0.359050657774262, 0.3838821865686707, 0.3862168678439895, 0.3897028482846384, 0.32766939238823856, 0.324442381695725, 0.3567028680328851, 0.3934752807560073, 0.3089047866258222, 0.3596323656730636, 0.37533945258353535, 0.33109400113337106]
    w_max = [1.4450316089127417, 1.3036121993933583, 1.4469212817587862, 1.159569386933975, 1.599584019144176, 1.0141827619118358, 1.1307390665431944, 0.9135762357906592, 1.441301386674112, 1.2948640613800233, 1.6034486539340267, 1.6905061107525299, 1.5827859925632368, 1.5477404337334006, 1.1253137097855133, 1.1726606724489788, 1.6059737833433019, 1.2418826623213843, 1.6437133163983373, 1.4325060738405182, 1.1387857314574976, 1.3762767027448157, 1.514216219105474, 1.2072455663803252, 1.6875686179674678, 1.0960960664418182, 1.5715122318541805, 1.4317744375387744, 1.0330487796268226, 1.5024653809747883, 1.2973450011194496, 0.9178697180336616, 1.19208416757479, 1.1536591294290262, 1.081213568118977, 1.0850338609118548, 0.9606869537478387, 1.363716038335237, 1.4522125492971407, 1.152204805176308, 1.3868762743948027, 0.9506040455960009, 1.483267169902117, 1.3619898625382567, 1.006387844434901, 1.1181661809788155, 1.5695114442104798, 0.9225871574353834, 0.9334807943415482, 0.9340170765193497,
             0.9762674384623545, 1.1436864500312938, 0.9768635648443806, 1.3938069174027397, 1.5347149908196407, 1.0791866586363812, 1.4314576851298937, 0.9743593599566728, 1.5154875003444173, 1.4721599580925444, 1.3698430310368117, 1.2001380815843279, 1.2173855181234543, 1.2762671737563849, 1.5131517488692334, 1.310085853687098, 0.9490545839487778, 1.0799734655624795, 1.6483130952690606, 1.0811491536939748, 0.9739009190800397, 1.5067366699555351, 1.2977954906036644, 1.6288831039145675, 1.0682361641603049, 1.1908764490942587, 1.0097192391237462, 1.0378233418132154, 1.4991547386369657, 1.3854186693832198, 0.9974304892719259, 1.5953920778286852, 1.02023547448896, 1.5658004593793926, 1.3959481962940614, 1.1969004949376743, 1.5935296924549205, 1.6270871110704053, 1.5430944316470852, 1.5604180382049941, 1.497719505454414, 1.3263534418150051, 1.3723326412501167, 0.9637420080880907, 1.1779992333054716, 1.6577736544893265, 0.9066847482027525, 0.933473945438753, 1.2399964933205223, 0.9957539804613164]
    gwn_std_dev = [0.07999604231452645, 0.09595366800958256, 0.09336411356151676, 0.13753875202136578, 0.11568793389172259, 0.1324341581330647, 0.1425565210598712, 0.12955088284722277, 0.11202288975398678, 0.1412396585164667, 0.07002776182275129, 0.0833879052111114, 0.09493958239747854, 0.116393761942352, 0.14155849309388988, 0.07146851372591456, 0.10022677170919488, 0.12378239438920143, 0.09180089826899401, 0.07674474180235996, 0.08034672513670661, 0.11755124799679512, 0.11953143680622214, 0.14223976273201738, 0.12786016591528565, 0.09456659744864548, 0.1441713652871987, 0.07870671144329561, 0.10177031058533105, 0.12909200759435147, 0.13324892608335687, 0.08238469330326224, 0.08391467752828351, 0.09559740417070454, 0.09776899795837452, 0.12480161905002066, 0.11083301336004188, 0.10552052623360536, 0.1331205919463976, 0.09224575763027683, 0.10890105126239276, 0.10926007820180875, 0.1092284906591659, 0.0731168482024747, 0.12427155784135177, 0.14622646542110757, 0.11924070164303832, 0.08231278360668724, 0.11570346654238309, 0.11128285942807223,
                   0.07342228829553436, 0.1389616859667812, 0.1381218454342844, 0.0844042899533831, 0.08519056111458728, 0.1130872230896817, 0.12916705412921342, 0.08618280760639743, 0.11944106375057068, 0.12501853001468632, 0.10463471493488455, 0.1314947073625024, 0.08265236284291597, 0.13973249115728129, 0.09994356443892835, 0.1272233438633784, 0.14878036022966357, 0.13598062042386366, 0.14858731158757177, 0.10765355471256058, 0.12017016814224013, 0.07884138388502993, 0.14883111738226512, 0.09206202643949116, 0.0718972467175729, 0.0858319085925907, 0.09278693743174285, 0.14084207704395035, 0.08940189164426787, 0.07828252440246258, 0.1374085618416958, 0.13476349688279338, 0.07068592153174508, 0.09346168484877235, 0.11749061888723815, 0.09118604158446081, 0.08494852593102714, 0.12567115841096352, 0.12737671215626142, 0.13563064448702972, 0.142555383287939, 0.08310016847166565, 0.144557861218378, 0.08779099349974938, 0.09078169976454135, 0.10639840668636942, 0.11374665474488843, 0.0983525959436938, 0.11285708330597363, 0.08160556016613567]

    parameter_dicts = {}

    for i in range(len(Cp_min)):
        parameter_dicts[i] = {
            'Cp_min': Cp_min[i],
            'Cp_max': Cp_max[i],
            'Cg_min': Cg_min[i],
            'Cg_max': Cg_max[i],
            'w_min': w_min[i],
            'w_max': w_max[i],
            'gwn_std_dev': gwn_std_dev[i]
        }

        run_pso_partial = partial(
            run_pso,
            iterations=iterations,
            position_bounds=position_bounds,
            velocity_bounds=velocity_bounds,
            fitness_threshold=fitness_threshold,
            num_particles=num_particles,
            Cp_min=parameter_dicts[i]["Cp_min"],
            Cp_max=parameter_dicts[i]["Cp_max"],
            Cg_min=parameter_dicts[i]["Cg_min"],
            Cg_max=parameter_dicts[i]["Cg_max"],
            w_min=parameter_dicts[i]["w_min"],
            w_max=parameter_dicts[i]["w_max"],
            gwn_std_dev=parameter_dicts[i]["gwn_std_dev"],
        )

        pso_runs = multiprocessing.cpu_count() - 1

        start_time = time.time()
        with multiprocessing.Pool(processes=multiprocessing.cpu_count() - 1) as pool:
            results = pool.map(run_pso_partial, range(pso_runs))
        end_time = time.time()
        elapsed_time = end_time - start_time

        fitness_histories = [result[2] for result in results]
        (
            swarm_best_fitness,
            swarm_best_position,
            swarm_fitness_history,
            swarm_position_history,
        ) = zip(*results)
        mean_best_fitness = np.mean(swarm_best_fitness)
        min_best_fitness = np.min(swarm_best_fitness)
        max_best_fitness = np.max(swarm_best_fitness)

        index_of_best_fitness = swarm_best_fitness.index(min_best_fitness)
        best_weights = swarm_best_position[index_of_best_fitness].tolist()

        sys.stdout.write(
            f"Minimum fitness for {pso_runs} runs: {min_best_fitness}. Mean: {mean_best_fitness}. Max: {max_best_fitness}"
        )

        save_opt_ann_rpso_stats(
            fitness_histories,
            "rpso",
            pso_runs,
            position_bounds,
            velocity_bounds,
            fitness_threshold,
            num_particles,
            parameter_dicts[i]["Cp_min"],
            parameter_dicts[i]["Cp_max"],
            parameter_dicts[i]["Cg_min"],
            parameter_dicts[i]["Cg_max"],
            parameter_dicts[i]["w_min"],
            parameter_dicts[i]["w_max"],
            parameter_dicts[i]["gwn_std_dev"],
            iterations,
            elapsed_time,
            min_best_fitness,
            mean_best_fitness,
            max_best_fitness,
            best_weights,
        )
